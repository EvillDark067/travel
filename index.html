<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Viagens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Theme Toggle -->
    <div class="fixed top-4 right-4 z-50">
        <button id="themeToggle" class="p-2 rounded-lg bg-white dark:bg-gray-800 shadow-lg border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-all">
            <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path class="sun-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                <path class="moon-icon hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Login Screen -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Controle de Viagens</h1>
                    <p class="text-gray-600 dark:text-gray-400">Fa√ßa login para continuar</p>
                </div>
                
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Usu√°rio</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
                        <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        Entrar
                    </button>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Painel Administrativo</h1>
                    <div class="flex gap-3">
                        <button id="logoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <button onclick="showUserManagement()" class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üë•</div>
                        <h3 class="text-lg font-semibold">Gerenciar Usu√°rios</h3>
                        <p class="text-blue-100 text-sm">Cadastrar e excluir motoristas</p>
                    </button>

                    <button onclick="showVehicleManagement()" class="p-6 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üöó</div>
                        <h3 class="text-lg font-semibold">Gerenciar Ve√≠culos</h3>
                        <p class="text-green-100 text-sm">Cadastrar e excluir ve√≠culos</p>
                    </button>

                    <button onclick="showReports()" class="p-6 bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üìä</div>
                        <h3 class="text-lg font-semibold">Relat√≥rios</h3>
                        <p class="text-purple-100 text-sm">Gerar PDFs e relat√≥rios</p>
                    </button>

                    <button onclick="showActiveTrips()" class="p-6 bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üöÄ</div>
                        <h3 class="text-lg font-semibold">Viagens em Andamento</h3>
                        <p class="text-orange-100 text-sm">Monitorar viagens ativas</p>
                    </button>

                    <button onclick="showCompletedTrips()" class="p-6 bg-gradient-to-br from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">‚úÖ</div>
                        <h3 class="text-lg font-semibold">Viagens Encerradas</h3>
                        <p class="text-teal-100 text-sm">Hist√≥rico e exporta√ß√£o</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- Driver Dashboard -->
        <div id="driverDashboard" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Painel do Motorista</h1>
                        <p class="text-gray-600 dark:text-gray-400" id="driverWelcome">Bem-vindo, Motorista!</p>
                    </div>
                    <button id="driverLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                        Sair do Sistema
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button onclick="showStartTrip()" class="p-6 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üöÄ</div>
                        <h3 class="text-lg font-semibold">Iniciar Viagem</h3>
                        <p class="text-green-100 text-sm">Nova viagem</p>
                    </button>

                    <button onclick="showEndTrip()" class="p-6 bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üèÅ</div>
                        <h3 class="text-lg font-semibold">Encerrar Viagem</h3>
                        <p class="text-orange-100 text-sm">Finalizar viagem atual</p>
                    </button>

                    <button onclick="showDriverHistory()" class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üìã</div>
                        <h3 class="text-lg font-semibold">Hist√≥rico</h3>
                        <p class="text-blue-100 text-sm">Minhas viagens</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Management Screen -->
        <div id="userManagement" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Gerenciar Usu√°rios</h2>
                    <div class="flex gap-3">
                        <button onclick="backToMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="userLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add User Form -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Cadastrar Novo Motorista</h3>
                        <form id="addUserForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome Completo</label>
                                <input type="text" id="newUserName" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Usu√°rio</label>
                                <input type="text" id="newUsername" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
                                <input type="password" id="newUserPassword" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                Cadastrar Motorista
                            </button>
                        </form>
                    </div>

                    <!-- Users List -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Motoristas Cadastrados</h3>
                        <div id="usersList" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Management Screen -->
        <div id="vehicleManagement" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Gerenciar Ve√≠culos</h2>
                    <div class="flex gap-3">
                        <button onclick="backToMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="vehicleLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add Vehicle Form -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Cadastrar Novo Ve√≠culo</h3>
                        <form id="addVehicleForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Placa</label>
                                <input type="text" id="vehiclePlate" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Marca</label>
                                <input type="text" id="vehicleBrand" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Modelo</label>
                                <input type="text" id="vehicleModel" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ano</label>
                                <input type="number" id="vehicleYear" required min="1900" max="2030" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                Cadastrar Ve√≠culo
                            </button>
                        </form>
                    </div>

                    <!-- Vehicles List -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ve√≠culos Cadastrados</h3>
                        <div id="vehiclesList" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Vehicles will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Screen -->
        <div id="reportsScreen" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Relat√≥rios</h2>
                    <div class="flex gap-3">
                        <button onclick="backToMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="reportsLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <button onclick="generateReport('10days')" class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üìÖ</div>
                        <h3 class="text-lg font-semibold">√öltimos 10 Dias</h3>
                        <p class="text-blue-100 text-sm">Gerar PDF</p>
                    </button>

                    <button onclick="generateReport('30days')" class="p-6 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-105">
                        <div class="text-2xl mb-2">üìä</div>
                        <h3 class="text-lg font-semibold">√öltimos 30 Dias</h3>
                        <p class="text-green-100 text-sm">Gerar PDF</p>
                    </button>

                    <div class="p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl shadow-lg">
                        <div class="text-2xl mb-2">üìã</div>
                        <h3 class="text-lg font-semibold mb-3">Per√≠odo Personalizado</h3>
                        <div class="space-y-3">
                            <input type="date" id="startDate" class="w-full px-3 py-2 rounded-lg text-gray-900 text-sm">
                            <input type="date" id="endDate" class="w-full px-3 py-2 rounded-lg text-gray-900 text-sm">
                            <button onclick="generateCustomReport()" class="w-full bg-white text-purple-600 font-medium py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors text-sm">
                                Gerar PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Trips Screen -->
        <div id="activeTripsScreen" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Viagens em Andamento</h2>
                    <div class="flex gap-3">
                        <button onclick="backToMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="activeTripsLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div id="activeTripsContainer" class="space-y-4">
                    <!-- Active trips will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Completed Trips Screen -->
        <div id="completedTripsScreen" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Viagens Encerradas</h2>
                    <div class="flex gap-3">
                        <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            Exportar CSV
                        </button>
                        <button onclick="backToMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="completedTripsLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="mb-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="date" id="filterStartDate" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        <input type="date" id="filterEndDate" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        <button onclick="filterTrips()" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            Filtrar
                        </button>
                    </div>
                </div>

                <div id="completedTripsContainer" class="space-y-4">
                    <!-- Completed trips will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Start Trip Screen -->
        <div id="startTripScreen" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Iniciar Viagem</h2>
                    <div class="flex gap-3">
                        <button onclick="backToDriverMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="startTripLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div class="max-w-md mx-auto">
                    <form id="startTripForm" class="space-y-6">
                        <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                            <p class="text-lg font-semibold text-gray-900 dark:text-white" id="startTripDriverName">Motorista: Nome do Motorista</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecionar Ve√≠culo</label>
                            <select id="tripVehicle" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                                <option value="">Escolha um ve√≠culo...</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quilometragem Inicial</label>
                            <input type="number" id="initialKm" required min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Destino</label>
                            <input type="text" id="destination" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        </div>

                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            Iniciar Viagem
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- End Trip Screen -->
        <div id="endTripScreen" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Encerrar Viagem</h2>
                    <div class="flex gap-3">
                        <button onclick="backToDriverMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="endTripLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div id="currentTripInfo" class="max-w-md mx-auto">
                    <!-- Current trip info will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Driver History Screen -->
        <div id="driverHistoryScreen" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Hist√≥rico de Viagens</h2>
                    <div class="flex gap-3">
                        <button onclick="backToDriverMenu()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Voltar ao Menu
                        </button>
                        <button id="historyLogoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            Sair do Sistema
                        </button>
                    </div>
                </div>

                <div id="driverHistoryContainer" class="space-y-4">
                    <!-- Driver history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = "https://selxmiekvyiqqgfcvhzy.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlbHhtaWVrdnlpcXFnZmN2aHp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MzExNzAsImV4cCI6MjA3MzMwNzE3MH0.WPJ0fltKZBz6epGsAiKq_4M3ptELw0Em8caV-2n84wc";
        const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

        // Global Variables
        let currentUser = null;
        let currentTrip = null;

        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const sunIcon = document.querySelector('.sun-icon');
        const moonIcon = document.querySelector('.moon-icon');

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            html.classList.add('dark');
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
        });

        // Screen Management
        function showScreen(screenId) {
            const screens = ['loginScreen', 'adminDashboard', 'driverDashboard', 'userManagement', 'vehicleManagement', 'reportsScreen', 'activeTripsScreen', 'completedTripsScreen', 'startTripScreen', 'endTripScreen', 'driverHistoryScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Authentication Functions
        async function login(username, password) {
            try {
                // Demo authentication - replace with actual Supabase auth
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error) throw error;
                
                currentUser = data;
                
                if (data.role === 'admin') {
                    showScreen('adminDashboard');
                } else if (data.role === 'driver') {
                    document.getElementById('driverWelcome').textContent = `Bem-vindo, ${data.name}!`;
                    showScreen('driverDashboard');
                }
                
                return true;
            } catch (error) {
                // Demo mode - allow demo login
                if (username === 'admin' && password === 'admin') {
                    currentUser = { id: 1, username: 'admin', name: 'Administrador', role: 'admin' };
                    showScreen('adminDashboard');
                    return true;
                } else if (username === 'motorista' && password === '123') {
                    currentUser = { id: 2, username: 'motorista', name: 'Jo√£o Silva', role: 'driver' };
                    document.getElementById('driverWelcome').textContent = `Bem-vindo, ${currentUser.name}!`;
                    showScreen('driverDashboard');
                    return true;
                }
                
                alert('Usu√°rio ou senha inv√°lidos');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            currentTrip = null;
            showScreen('loginScreen');
            document.getElementById('loginForm').reset();
        }

        // Navigation Functions
        function backToMenu() {
            if (currentUser.role === 'admin') {
                showScreen('adminDashboard');
            } else {
                showScreen('driverDashboard');
            }
        }

        function backToDriverMenu() {
            showScreen('driverDashboard');
        }

        // User Management Functions
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('role', 'driver');

                if (error) throw error;

                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';

                // Demo data if no users found
                const users = data.length > 0 ? data : [
                    { id: 2, name: 'Jo√£o Silva', username: 'joao' },
                    { id: 3, name: 'Maria Santos', username: 'maria' }
                ];

                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600';
                    userDiv.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">${user.name}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">@${user.username}</p>
                        </div>
                        <button onclick="deleteUser(${user.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors">
                            Excluir
                        </button>
                    `;
                    usersList.appendChild(userDiv);
                });
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }

        async function addUser(name, username, password) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([
                        { name, username, password, role: 'driver' }
                    ]);

                if (error) throw error;

                alert('Motorista cadastrado com sucesso!');
                document.getElementById('addUserForm').reset();
                loadUsers();
            } catch (error) {
                alert('Erro ao cadastrar motorista: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (confirm('Tem certeza que deseja excluir este motorista?')) {
                try {
                    const { error } = await supabase
                        .from('users')
                        .delete()
                        .eq('id', userId);

                    if (error) throw error;

                    alert('Motorista exclu√≠do com sucesso!');
                    loadUsers();
                } catch (error) {
                    alert('Erro ao excluir motorista: ' + error.message);
                }
            }
        }

        // Vehicle Management Functions
        async function loadVehicles() {
            try {
                const { data, error } = await supabase
                    .from('vehicles')
                    .select('*');

                if (error) throw error;

                const vehiclesList = document.getElementById('vehiclesList');
                vehiclesList.innerHTML = '';

                // Demo data if no vehicles found
                const vehicles = data.length > 0 ? data : [
                    { id: 1, plate: 'ABC-1234', brand: 'Toyota', model: 'Corolla', year: 2020 },
                    { id: 2, plate: 'XYZ-5678', brand: 'Honda', model: 'Civic', year: 2019 }
                ];

                vehicles.forEach(vehicle => {
                    const vehicleDiv = document.createElement('div');
                    vehicleDiv.className = 'flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600';
                    vehicleDiv.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">${vehicle.plate}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${vehicle.brand} ${vehicle.model} (${vehicle.year})</p>
                        </div>
                        <button onclick="deleteVehicle(${vehicle.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors">
                            Excluir
                        </button>
                    `;
                    vehiclesList.appendChild(vehicleDiv);
                });
            } catch (error) {
                console.error('Erro ao carregar ve√≠culos:', error);
            }
        }

        async function addVehicle(plate, brand, model, year) {
            try {
                const { data, error } = await supabase
                    .from('vehicles')
                    .insert([
                        { plate, brand, model, year: parseInt(year) }
                    ]);

                if (error) throw error;

                alert('Ve√≠culo cadastrado com sucesso!');
                document.getElementById('addVehicleForm').reset();
                loadVehicles();
            } catch (error) {
                alert('Erro ao cadastrar ve√≠culo: ' + error.message);
            }
        }

        async function deleteVehicle(vehicleId) {
            if (confirm('Tem certeza que deseja excluir este ve√≠culo?')) {
                try {
                    const { error } = await supabase
                        .from('vehicles')
                        .delete()
                        .eq('id', vehicleId);

                    if (error) throw error;

                    alert('Ve√≠culo exclu√≠do com sucesso!');
                    loadVehicles();
                } catch (error) {
                    alert('Erro ao excluir ve√≠culo: ' + error.message);
                }
            }
        }

        // Trip Management Functions
        async function loadAvailableVehicles() {
            try {
                const { data: vehicles, error: vehiclesError } = await supabase
                    .from('vehicles')
                    .select('*');

                if (vehiclesError) throw vehiclesError;

                const { data: activeTrips, error: tripsError } = await supabase
                    .from('trips')
                    .select('vehicle_id')
                    .is('end_time', null);

                if (tripsError) throw tripsError;

                const usedVehicleIds = activeTrips.map(trip => trip.vehicle_id);
                const availableVehicles = vehicles.filter(vehicle => !usedVehicleIds.includes(vehicle.id));

                const select = document.getElementById('tripVehicle');
                select.innerHTML = '<option value="">Escolha um ve√≠culo...</option>';

                // Demo data if no vehicles found
                const vehiclesToShow = availableVehicles.length > 0 ? availableVehicles : [
                    { id: 1, plate: 'ABC-1234', brand: 'Toyota', model: 'Corolla' },
                    { id: 2, plate: 'XYZ-5678', brand: 'Honda', model: 'Civic' }
                ];

                vehiclesToShow.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.plate} - ${vehicle.brand} ${vehicle.model}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar ve√≠culos dispon√≠veis:', error);
            }
        }

        async function startTrip(vehicleId, initialKm, destination) {
            try {
                const { data, error } = await supabase
                    .from('trips')
                    .insert([
                        {
                            driver_id: currentUser.id,
                            vehicle_id: vehicleId,
                            destination,
                            initial_km: parseInt(initialKm),
                            start_time: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();

                if (error) throw error;

                currentTrip = data;
                alert('Viagem iniciada com sucesso!');
                document.getElementById('startTripForm').reset();
                backToDriverMenu();
            } catch (error) {
                alert('Erro ao iniciar viagem: ' + error.message);
            }
        }

        async function loadCurrentTrip() {
            try {
                const { data, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        vehicles (plate, brand, model)
                    `)
                    .eq('driver_id', currentUser.id)
                    .is('end_time', null)
                    .single();

                if (error) {
                    // No active trip
                    document.getElementById('currentTripInfo').innerHTML = `
                        <div class="text-center p-8">
                            <p class="text-gray-600 dark:text-gray-400">Nenhuma viagem em andamento</p>
                        </div>
                    `;
                    return;
                }

                currentTrip = data;
                
                document.getElementById('currentTripInfo').innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Viagem em Andamento</h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Ve√≠culo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${data.vehicles.plate} - ${data.vehicles.brand} ${data.vehicles.model}</p>
                            </div>
                            
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Destino</p>
                                <p class="font-medium text-gray-900 dark:text-white">${data.destination}</p>
                            </div>
                            
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-400">KM Inicial</p>
                                <p class="font-medium text-gray-900 dark:text-white">${data.initial_km}</p>
                            </div>
                            
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-400">In√≠cio</p>
                                <p class="font-medium text-gray-900 dark:text-white">${new Date(data.start_time).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                        
                        <form id="endTripForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quilometragem Final</label>
                                <input type="number" id="finalKm" required min="${data.initial_km}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            </div>
                            
                            <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                Encerrar Viagem
                            </button>
                        </form>
                    </div>
                `;

                document.getElementById('endTripForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const finalKm = parseInt(document.getElementById('finalKm').value);
                    
                    if (finalKm < data.initial_km) {
                        alert('A quilometragem final n√£o pode ser menor que a inicial');
                        return;
                    }
                    
                    await endTrip(finalKm);
                });

            } catch (error) {
                console.error('Erro ao carregar viagem atual:', error);
            }
        }

        async function endTrip(finalKm) {
            try {
                const { error } = await supabase
                    .from('trips')
                    .update({
                        final_km: finalKm,
                        end_time: new Date().toISOString()
                    })
                    .eq('id', currentTrip.id);

                if (error) throw error;

                alert('Viagem encerrada com sucesso!');
                currentTrip = null;
                backToDriverMenu();
            } catch (error) {
                alert('Erro ao encerrar viagem: ' + error.message);
            }
        }

        // Reports Functions
        async function generateReport(period) {
            let startDate, endDate;
            const now = new Date();
            
            if (period === '10days') {
                startDate = new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000);
                endDate = now;
            } else if (period === '30days') {
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                endDate = now;
            }
            
            await createPDFReport(startDate, endDate);
        }

        async function generateCustomReport() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione as datas');
                return;
            }
            
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays > 31) {
                alert('O per√≠odo n√£o pode ser maior que 31 dias');
                return;
            }
            
            await createPDFReport(startDate, endDate);
        }

        async function createPDFReport(startDate, endDate) {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        users (name),
                        vehicles (plate, brand, model)
                    `)
                    .gte('start_time', startDate.toISOString())
                    .lte('start_time', endDate.toISOString())
                    .not('end_time', 'is', null);

                if (error) throw error;

                // Demo data if no trips found
                const tripsData = trips.length > 0 ? trips : [
                    {
                        users: { name: 'Jo√£o Silva' },
                        vehicles: { plate: 'ABC-1234', brand: 'Toyota', model: 'Corolla' },
                        destination: 'Centro da Cidade',
                        start_time: new Date().toISOString(),
                        end_time: new Date().toISOString(),
                        initial_km: 10000,
                        final_km: 10050
                    }
                ];

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(16);
                doc.text('Relat√≥rio de Viagens', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Per√≠odo: ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}`, 20, 35);

                let y = 50;
                tripsData.forEach((trip, index) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }

                    const kmPercorrido = trip.final_km - trip.initial_km;
                    
                    doc.text(`${index + 1}. Motorista: ${trip.users.name}`, 20, y);
                    doc.text(`   Ve√≠culo: ${trip.vehicles.plate} - ${trip.vehicles.brand} ${trip.vehicles.model}`, 20, y + 10);
                    doc.text(`   Destino: ${trip.destination}`, 20, y + 20);
                    doc.text(`   In√≠cio: ${new Date(trip.start_time).toLocaleString('pt-BR')}`, 20, y + 30);
                    doc.text(`   Fim: ${new Date(trip.end_time).toLocaleString('pt-BR')}`, 20, y + 40);
                    doc.text(`   KM Inicial: ${trip.initial_km} | KM Final: ${trip.final_km} | KM Percorrido: ${kmPercorrido}`, 20, y + 50);
                    
                    y += 70;
                });

                // Signature field
                doc.text('Assinatura: ________________________________', 20, y + 20);

                doc.save(`relatorio-viagens-${startDate.toISOString().split('T')[0]}-${endDate.toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                alert('Erro ao gerar relat√≥rio: ' + error.message);
            }
        }

        // CSV Export Function
        async function exportCSV() {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        users (name),
                        vehicles (plate, brand, model)
                    `)
                    .not('end_time', 'is', null);

                if (error) throw error;

                // Demo data if no trips found
                const tripsData = trips.length > 0 ? trips : [
                    {
                        users: { name: 'Jo√£o Silva' },
                        vehicles: { plate: 'ABC-1234', brand: 'Toyota', model: 'Corolla' },
                        destination: 'Centro da Cidade',
                        start_time: new Date().toISOString(),
                        end_time: new Date().toISOString(),
                        initial_km: 10000,
                        final_km: 10050
                    }
                ];

                let csv = 'Motorista,Ve√≠culo,Destino,In√≠cio,Fim,KM Inicial,KM Final,KM Percorrido\n';
                
                tripsData.forEach(trip => {
                    const kmPercorrido = trip.final_km - trip.initial_km;
                    csv += `"${trip.users.name}","${trip.vehicles.plate} - ${trip.vehicles.brand} ${trip.vehicles.model}","${trip.destination}","${new Date(trip.start_time).toLocaleString('pt-BR')}","${new Date(trip.end_time).toLocaleString('pt-BR')}",${trip.initial_km},${trip.final_km},${kmPercorrido}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `viagens-encerradas-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Erro ao exportar CSV: ' + error.message);
            }
        }

        // Load Functions for Different Screens
        async function loadActiveTrips() {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        users (name),
                        vehicles (plate, brand, model)
                    `)
                    .is('end_time', null);

                if (error) throw error;

                const container = document.getElementById('activeTripsContainer');
                
                if (trips.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-8">
                            <p class="text-gray-600 dark:text-gray-400">Nenhuma viagem em andamento</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                trips.forEach(trip => {
                    const tripDiv = document.createElement('div');
                    tripDiv.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-xl';
                    tripDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Motorista</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.users.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Ve√≠culo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.vehicles.plate}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Destino</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.destination}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">In√≠cio</p>
                                <p class="font-medium text-gray-900 dark:text-white">${new Date(trip.start_time).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(tripDiv);
                });
            } catch (error) {
                console.error('Erro ao carregar viagens ativas:', error);
            }
        }

        async function loadCompletedTrips() {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        users (name),
                        vehicles (plate, brand, model)
                    `)
                    .not('end_time', 'is', null)
                    .order('end_time', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('completedTripsContainer');
                
                // Demo data if no trips found
                const tripsData = trips.length > 0 ? trips : [
                    {
                        users: { name: 'Jo√£o Silva' },
                        vehicles: { plate: 'ABC-1234', brand: 'Toyota', model: 'Corolla' },
                        destination: 'Centro da Cidade',
                        start_time: new Date().toISOString(),
                        end_time: new Date().toISOString(),
                        initial_km: 10000,
                        final_km: 10050
                    }
                ];

                container.innerHTML = '';
                tripsData.forEach(trip => {
                    const kmPercorrido = trip.final_km - trip.initial_km;
                    const tripDiv = document.createElement('div');
                    tripDiv.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-xl';
                    tripDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Motorista</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.users.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Ve√≠culo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.vehicles.plate}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Destino</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.destination}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Per√≠odo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${new Date(trip.start_time).toLocaleDateString('pt-BR')} - ${new Date(trip.end_time).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">KM Percorrido</p>
                                <p class="font-medium text-gray-900 dark:text-white">${kmPercorrido} km</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(tripDiv);
                });
            } catch (error) {
                console.error('Erro ao carregar viagens encerradas:', error);
            }
        }

        async function loadDriverHistory() {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        vehicles (plate, brand, model)
                    `)
                    .eq('driver_id', currentUser.id)
                    .not('end_time', 'is', null)
                    .order('end_time', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('driverHistoryContainer');
                
                // Demo data if no trips found
                const tripsData = trips.length > 0 ? trips : [
                    {
                        vehicles: { plate: 'ABC-1234', brand: 'Toyota', model: 'Corolla' },
                        destination: 'Centro da Cidade',
                        start_time: new Date().toISOString(),
                        end_time: new Date().toISOString(),
                        initial_km: 10000,
                        final_km: 10050
                    }
                ];

                container.innerHTML = '';
                tripsData.forEach(trip => {
                    const kmPercorrido = trip.final_km - trip.initial_km;
                    const tripDiv = document.createElement('div');
                    tripDiv.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-xl';
                    tripDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Ve√≠culo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.vehicles.plate} - ${trip.vehicles.brand} ${trip.vehicles.model}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Destino</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.destination}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Data</p>
                                <p class="font-medium text-gray-900 dark:text-white">${new Date(trip.start_time).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">KM Percorrido</p>
                                <p class="font-medium text-gray-900 dark:text-white">${kmPercorrido} km</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(tripDiv);
                });
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }

        // Screen Show Functions
        function showUserManagement() {
            showScreen('userManagement');
            loadUsers();
        }

        function showVehicleManagement() {
            showScreen('vehicleManagement');
            loadVehicles();
        }

        function showReports() {
            showScreen('reportsScreen');
        }

        function showActiveTrips() {
            showScreen('activeTripsScreen');
            loadActiveTrips();
        }

        function showCompletedTrips() {
            showScreen('completedTripsScreen');
            loadCompletedTrips();
        }

        function showStartTrip() {
            showScreen('startTripScreen');
            document.getElementById('startTripDriverName').textContent = `Motorista: ${currentUser.name}`;
            loadAvailableVehicles();
        }

        function showEndTrip() {
            showScreen('endTripScreen');
            loadCurrentTrip();
        }

        function showDriverHistory() {
            showScreen('driverHistoryScreen');
            loadDriverHistory();
        }

        // Event Listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await login(username, password);
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newUserName').value;
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            await addUser(name, username, password);
        });

        document.getElementById('addVehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const plate = document.getElementById('vehiclePlate').value;
            const brand = document.getElementById('vehicleBrand').value;
            const model = document.getElementById('vehicleModel').value;
            const year = document.getElementById('vehicleYear').value;
            await addVehicle(plate, brand, model, year);
        });

        document.getElementById('startTripForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const vehicleId = document.getElementById('tripVehicle').value;
            const initialKm = document.getElementById('initialKm').value;
            const destination = document.getElementById('destination').value;
            await startTrip(vehicleId, initialKm, destination);
        });

        // Logout button event listeners
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('driverLogoutBtn').addEventListener('click', logout);
        document.getElementById('userLogoutBtn').addEventListener('click', logout);
        document.getElementById('vehicleLogoutBtn').addEventListener('click', logout);
        document.getElementById('reportsLogoutBtn').addEventListener('click', logout);
        document.getElementById('activeTripsLogoutBtn').addEventListener('click', logout);
        document.getElementById('completedTripsLogoutBtn').addEventListener('click', logout);
        document.getElementById('startTripLogoutBtn').addEventListener('click', logout);
        document.getElementById('endTripLogoutBtn').addEventListener('click', logout);
        document.getElementById('historyLogoutBtn').addEventListener('click', logout);

        // Filter trips function
        async function filterTrips() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                loadCompletedTrips();
                return;
            }
            
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        users (name),
                        vehicles (plate, brand, model)
                    `)
                    .not('end_time', 'is', null)
                    .gte('start_time', startDate)
                    .lte('start_time', endDate)
                    .order('end_time', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('completedTripsContainer');
                container.innerHTML = '';
                
                if (trips.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-8">
                            <p class="text-gray-600 dark:text-gray-400">Nenhuma viagem encontrada no per√≠odo selecionado</p>
                        </div>
                    `;
                    return;
                }

                trips.forEach(trip => {
                    const kmPercorrido = trip.final_km - trip.initial_km;
                    const tripDiv = document.createElement('div');
                    tripDiv.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-xl';
                    tripDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Motorista</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.users.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Ve√≠culo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.vehicles.plate}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Destino</p>
                                <p class="font-medium text-gray-900 dark:text-white">${trip.destination}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Per√≠odo</p>
                                <p class="font-medium text-gray-900 dark:text-white">${new Date(trip.start_time).toLocaleDateString('pt-BR')} - ${new Date(trip.end_time).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">KM Percorrido</p>
                                <p class="font-medium text-gray-900 dark:text-white">${kmPercorrido} km</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(tripDiv);
                });
            } catch (error) {
                console.error('Erro ao filtrar viagens:', error);
            }
        }

        // Initialize the application
        showScreen('loginScreen');
    </script>

    
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e45b9f07d7a623',t:'MTc1NzczMjA0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
