<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Viagens</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .text-gradient {
            background-image: linear-gradient(45deg, #4F46E5, #9333EA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4F46E5, #9333EA);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(100, 50, 200, 0.3);
        }
        .card-container {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .dark .card-container:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center">

    <!-- Conte√∫do Principal -->
    <div class="container mx-auto px-4 py-8 max-w-7xl relative">

        <!-- Theme Toggle -->
        <button id="themeToggle" class="fixed top-4 right-4 p-2 rounded-full bg-white dark:bg-gray-800 shadow-md transition-all z-50">
            <svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path class="sun-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                <path class="moon-icon hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
        </button>

        <!-- Modals -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div id="modal-content" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
                <div id="modal-message" class="text-center text-lg mb-4 text-gray-900 dark:text-gray-100"></div>
                <div class="flex justify-center">
                    <button id="modal-ok-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">OK</button>
                </div>
            </div>
        </div>

        <!-- Tela de Login -->
        <div id="loginScreen" class="flex flex-col items-center justify-center fade-in">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-gradient mb-2">Login</h1>
                    <p class="text-gray-600 dark:text-gray-400">Entre para continuar</p>
                </div>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Usu√°rio</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
                        <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-lg">Entrar</button>
                </form>
            </div>
        </div>

        <!-- Painel Administrativo -->
        <div id="adminDashboard" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Painel Administrativo</h1>
                <div class="flex gap-2 sm:gap-4">
                    <button id="logoutBtn" class="px-3 py-2 sm:px-4 sm:py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">Sair</button>
                </div>
            </div>

            <div id="adminMenu" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Bot√£o Gerenciar Usu√°rios -->
                <button id="manageUsersBtn" class="bg-white dark:bg-gray-800 card-container p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 text-center">
                    <svg class="w-12 h-12 mx-auto mb-4 text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm0 14c-2.67 0-5.34-1.1-7.15-2.9-1.81-1.81-2.9-4.5-2.9-7.1s1.09-5.29 2.9-7.1C6.66 4.1 9.33 3 12 3s5.34 1.1 7.15 2.9c1.81 1.81 2.9 4.5 2.9 7.1s-1.09 5.29-2.9 7.1c-1.81 1.81-4.48 2.9-7.15 2.9zM7 16c0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3-3 1.34-3 3z"></path>
                    </svg>
                    <span class="text-xl font-semibold">Gerenciar Usu√°rios</span>
                </button>
                <!-- Bot√£o Gerenciar Ve√≠culos -->
                <button id="manageVehiclesBtn" class="bg-white dark:bg-gray-800 card-container p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 text-center">
                    <svg class="w-12 h-12 mx-auto mb-4 text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"></path>
                    </svg>
                    <span class="text-xl font-semibold">Gerenciar Ve√≠culos</span>
                </button>
                <!-- Bot√£o Status das Viagens -->
                <button id="viewTripsBtn" class="bg-white dark:bg-gray-800 card-container p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 text-center">
                    <svg class="w-12 h-12 mx-auto mb-4 text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path>
                    </svg>
                    <span class="text-xl font-semibold">Status das Viagens</span>
                </button>
                <!-- Bot√£o Relat√≥rios -->
                <button id="viewReportBtn" class="bg-white dark:bg-gray-800 card-container p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 text-center">
                    <svg class="w-12 h-12 mx-auto mb-4 text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path>
                    </svg>
                    <span class="text-xl font-semibold">Relat√≥rios</span>
                </button>
            </div>
        </div>

        <!-- Telas de Gerenciamento do Admin (hidden by default) -->
        <div id="adminScreens" class="hidden fade-in">
            <button id="backToAdminMenuBtn" class="mb-4 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-800 dark:text-gray-200 transition-colors">
                &larr; Voltar ao Menu Principal
            </button>
            <div id="userManagementScreen" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Gerenciar Usu√°rios</h2>
                <!-- Formul√°rio e Tabela de Usu√°rios -->
                <form id="userForm" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-200 dark:border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="userName" class="block text-sm font-medium mb-1">Nome</label>
                            <input type="text" id="userName" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="userPassword" class="block text-sm font-medium mb-1">Senha</label>
                            <input type="password" id="userPassword" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                        </div>
                    </div>
                    <button type="submit" class="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">Cadastrar Usu√°rio</button>
                </form>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Usu√°rios Cadastrados</h3>
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Usu√°rios ser√£o inseridos aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="vehicleManagementScreen" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Gerenciar Ve√≠culos</h2>
                <!-- Formul√°rio e Tabela de Ve√≠culos -->
                <form id="vehicleForm" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-200 dark:border-gray-700">
                    <div>
                        <label for="vehiclePlate" class="block text-sm font-medium mb-1">Placa do Ve√≠culo</label>
                        <input type="text" id="vehiclePlate" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                    </div>
                    <button type="submit" class="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">Cadastrar Ve√≠culo</button>
                </form>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Ve√≠culos Cadastrados</h3>
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="vehicleTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Ve√≠culos ser√£o inseridos aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tripStatusScreen" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Status das Viagens</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Viagens em Tr√¢nsito -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-xl font-semibold mb-4">Viagens em Tr√¢nsito</h3>
                        <div id="inTransitTrips" class="space-y-4">
                            <!-- Viagens em tr√¢nsito ser√£o inseridas aqui -->
                        </div>
                    </div>
                    <!-- Viagens Encerradas -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="text-xl font-semibold mb-4">Viagens Encerradas</h3>
                        <div class="mb-4">
                            <input type="text" id="filterTripInput" placeholder="Filtrar por nome do motorista ou placa" class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                        </div>
                        <div id="closedTrips" class="space-y-4">
                            <!-- Viagens encerradas ser√£o inseridas aqui -->
                        </div>
                        <button id="downloadCsvBtn" class="mt-4 w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">Baixar CSV</button>
                    </div>
                </div>
            </div>

            <div id="reportScreen" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Relat√≥rios</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-200 dark:border-gray-700">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="reportDriverSelect" class="block text-sm font-medium mb-1">Selecionar Motorista</label>
                            <select id="reportDriverSelect" class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                                <!-- Op√ß√µes de motorista ser√£o inseridas aqui -->
                            </select>
                        </div>
                        <div>
                            <label for="reportPeriodSelect" class="block text-sm font-medium mb-1">Per√≠odo</label>
                            <select id="reportPeriodSelect" class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="15">√öltimos 15 dias</option>
                                <option value="30">√öltimos 30 dias</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="generatePdfBtn" class="w-full px-4 py-2 btn-primary text-white rounded-lg shadow-lg">Gerar PDF</button>
                        </div>
                    </div>
                    <div id="pdfOutput" class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700 h-96 overflow-auto">
                        <!-- Preview do PDF aqui (opcional) -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel do Motorista -->
        <div id="driverDashboard" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Bem-vindo, <span id="driverName" class="text-gradient"></span>!</h1>
                <div class="flex gap-2 sm:gap-4">
                    <button id="driverLogoutBtn" class="px-3 py-2 sm:px-4 sm:py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">Sair</button>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 mb-6">
                <h2 class="text-2xl font-bold mb-4">Iniciar / Encerrar Viagem</h2>
                <form id="tripForm" class="space-y-4">
                    <div>
                        <label for="startKm" class="block text-sm font-medium mb-1">Quilometragem Inicial</label>
                        <input type="number" id="startKm" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" min="0">
                    </div>
                    <div>
                        <label for="vehicleSelect" class="block text-sm font-medium mb-1">Ve√≠culo</label>
                        <select id="vehicleSelect" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                            <!-- Ve√≠culos dispon√≠veis ser√£o inseridos aqui -->
                        </select>
                    </div>
                    <div>
                        <label for="destination" class="block text-sm font-medium mb-1">Destino</label>
                        <input type="text" id="destination" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                    </div>
                    <div id="tripControls" class="flex gap-4 mt-4">
                        <button type="button" id="startTripBtn" class="flex-1 btn-primary text-white font-semibold py-3 rounded-lg shadow-lg">Iniciar Viagem</button>
                        <button type="button" id="endTripBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg shadow-lg hidden">Encerrar Viagem</button>
                    </div>
                </form>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-bold mb-4">Minhas Viagens Encerradas</h2>
                <div id="myTrips" class="space-y-4">
                    <!-- Hist√≥rico de viagens do motorista ser√° inserido aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const show = (element) => element.classList.remove('hidden');
        const hide = (element) => element.classList.add('hidden');

        // Estado Global
        let currentUser = null;
        let currentTrip = null;
        let vehicles = [];
        let users = [];
        let trips = [];

        // Elementos da UI
        const loginScreen = document.getElementById('loginScreen');
        const adminDashboard = document.getElementById('adminDashboard');
        const driverDashboard = document.getElementById('driverDashboard');
        const adminScreens = document.getElementById('adminScreens');
        const userManagementScreen = document.getElementById('userManagementScreen');
        const vehicleManagementScreen = document.getElementById('vehicleManagementScreen');
        const tripStatusScreen = document.getElementById('tripStatusScreen');
        const reportScreen = document.getElementById('reportScreen');

        // Bot√µes
        const logoutBtn = document.getElementById('logoutBtn');
        const driverLogoutBtn = document.getElementById('driverLogoutBtn');
        const backToAdminMenuBtn = document.getElementById('backToAdminMenuBtn');
        const manageUsersBtn = document.getElementById('manageUsersBtn');
        const manageVehiclesBtn = document.getElementById('manageVehiclesBtn');
        const viewTripsBtn = document.getElementById('viewTripsBtn');
        const viewReportBtn = document.getElementById('viewReportBtn');

        // Forms e Inputs
        const loginForm = document.getElementById('loginForm');
        const tripForm = document.getElementById('tripForm');
        const startTripBtn = document.getElementById('startTripBtn');
        const endTripBtn = document.getElementById('endTripBtn');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const reportDriverSelect = document.getElementById('reportDriverSelect');
        const reportPeriodSelect = document.getElementById('reportPeriodSelect');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const filterTripInput = document.getElementById('filterTripInput');

        // Modals
        const modalContainer = document.getElementById('modal-container');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        const showModal = (message) => {
            modalMessage.textContent = message;
            show(modalContainer);
        };

        modalOkBtn.addEventListener('click', () => {
            hide(modalContainer);
        });

        // Simula√ß√£o de Banco de Dados
        const db = {
            users: [
                { id: 'admin', username: 'admin', password: '123', role: 'admin' },
                { id: 'motorista1', username: 'motorista1', password: '123', role: 'driver' },
                { id: 'motorista2', username: 'motorista2', password: '123', role: 'driver' }
            ],
            vehicles: [
                { id: 'abc1234', plate: 'ABC-1234', inUse: false },
                { id: 'xyz5678', plate: 'XYZ-5678', inUse: false }
            ],
            trips: [
                { id: 't1', driver: 'motorista1', vehicle: 'ABC-1234', destination: 'S√£o Paulo', startKm: 100, endKm: 250, startTime: new Date('2024-05-10T08:00:00'), endTime: new Date('2024-05-10T12:00:00'), status: 'completed' },
                { id: 't2', driver: 'motorista2', vehicle: 'XYZ-5678', destination: 'Rio de Janeiro', startKm: 50, endKm: 300, startTime: new Date('2024-05-11T14:00:00'), endTime: new Date('2024-05-11T18:00:00'), status: 'completed' }
            ]
        };

        const loadData = () => {
            users = db.users;
            vehicles = db.vehicles;
            trips = db.trips;
        };
        
        const saveData = () => {
            // Em uma aplica√ß√£o real, salvaria no banco de dados
            db.users = users;
            db.vehicles = vehicles;
            db.trips = trips;
        };

        // Fun√ß√µes de Renderiza√ß√£o
        const renderScreen = (screenId) => {
            hide(loginScreen);
            hide(adminDashboard);
            hide(driverDashboard);
            hide(adminScreens);
            hide(userManagementScreen);
            hide(vehicleManagementScreen);
            hide(tripStatusScreen);
            hide(reportScreen);

            if (screenId === 'login') {
                show(loginScreen);
            } else if (screenId === 'admin') {
                show(adminDashboard);
            } else if (screenId === 'driver') {
                document.getElementById('driverName').textContent = currentUser.username;
                show(driverDashboard);
                updateDriverTripUI();
                renderMyTrips();
            } else if (screenId === 'manageUsers') {
                show(adminScreens);
                show(userManagementScreen);
                renderUserTable();
            } else if (screenId === 'manageVehicles') {
                show(adminScreens);
                show(vehicleManagementScreen);
                renderVehicleTable();
            } else if (screenId === 'viewTrips') {
                show(adminScreens);
                show(tripStatusScreen);
                renderTripStatus();
            } else if (screenId === 'viewReport') {
                show(adminScreens);
                show(reportScreen);
                renderReportOptions();
            }
        };

        const renderUserTable = () => {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            users.filter(u => u.role !== 'admin').forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        const renderVehicleTable = () => {
            const tableBody = document.getElementById('vehicleTableBody');
            tableBody.innerHTML = '';
            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${vehicle.plate}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="deleteVehicle('${vehicle.id}')" class="text-red-600 hover:text-red-900">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        const renderTripStatus = (filterText = '') => {
            const inTransitDiv = document.getElementById('inTransitTrips');
            const closedDiv = document.getElementById('closedTrips');
            inTransitDiv.innerHTML = '';
            closedDiv.innerHTML = '';

            const filteredTrips = trips.filter(trip => {
                const driver = users.find(u => u.id === trip.driver)?.username || 'Desconhecido';
                const vehicle = vehicles.find(v => v.id === trip.vehicle)?.plate || 'Desconhecido';
                const text = `${driver} ${vehicle} ${trip.destination}`.toLowerCase();
                return text.includes(filterText.toLowerCase());
            });

            filteredTrips.forEach(trip => {
                const driverName = users.find(u => u.id === trip.driver)?.username;
                const vehiclePlate = vehicles.find(v => v.id === trip.vehicle)?.plate;
                const tripCard = document.createElement('div');
                tripCard.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-md';
                tripCard.innerHTML = `
                    <p class="font-semibold">${driverName} - ${vehiclePlate}</p>
                    <p class="text-sm">Destino: ${trip.destination}</p>
                    <p class="text-sm">In√≠cio: ${new Date(trip.startTime).toLocaleString()}</p>
                    ${trip.status === 'completed' ? `<p class="text-sm">Fim: ${new Date(trip.endTime).toLocaleString()}</p><p class="text-sm">KM Inicial: ${trip.startKm} - KM Final: ${trip.endKm}</p><p class="text-sm">Total KM: ${trip.endKm - trip.startKm}</p>` : ''}
                `;
                if (trip.status === 'in-transit') {
                    inTransitDiv.appendChild(tripCard);
                } else {
                    closedDiv.appendChild(tripCard);
                }
            });
        };

        const renderReportOptions = () => {
            reportDriverSelect.innerHTML = '<option value="">Todos os Motoristas</option>';
            users.filter(u => u.role === 'driver').forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                reportDriverSelect.appendChild(option);
            });
        };

        const renderMyTrips = () => {
            const myTripsDiv = document.getElementById('myTrips');
            myTripsDiv.innerHTML = '';
            const driverTrips = trips.filter(trip => trip.driver === currentUser.id && trip.status === 'completed');
            if (driverTrips.length === 0) {
                myTripsDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Nenhuma viagem conclu√≠da.</p>';
                return;
            }
            driverTrips.forEach(trip => {
                const vehiclePlate = vehicles.find(v => v.id === trip.vehicle)?.plate;
                const tripCard = document.createElement('div');
                tripCard.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-md';
                tripCard.innerHTML = `
                    <p class="font-semibold">Ve√≠culo: ${vehiclePlate}</p>
                    <p class="text-sm">Destino: ${trip.destination}</p>
                    <p class="text-sm">Data: ${new Date(trip.startTime).toLocaleDateString()}</p>
                    <p class="text-sm">Quilometragem Percorrida: ${trip.endKm - trip.startKm} km</p>
                `;
                myTripsDiv.appendChild(tripCard);
            });
        };

        const updateDriverTripUI = () => {
            const activeTrip = trips.find(t => t.driver === currentUser.id && t.status === 'in-transit');
            if (activeTrip) {
                currentTrip = activeTrip;
                hide(startTripBtn);
                show(endTripBtn);
                document.getElementById('startKm').value = currentTrip.startKm;
                document.getElementById('vehicleSelect').value = currentTrip.vehicle;
                document.getElementById('destination').value = currentTrip.destination;
                document.getElementById('startKm').disabled = true;
                document.getElementById('vehicleSelect').disabled = true;
                document.getElementById('destination').disabled = true;
            } else {
                currentTrip = null;
                show(startTripBtn);
                hide(endTripBtn);
                document.getElementById('startKm').value = '';
                document.getElementById('destination').value = '';
                document.getElementById('startKm').disabled = false;
                document.getElementById('vehicleSelect').disabled = false;
                document.getElementById('destination').disabled = false;
                renderAvailableVehicles();
            }
        };

        const renderAvailableVehicles = () => {
            vehicleSelect.innerHTML = '<option value="" disabled selected>Selecione um ve√≠culo</option>';
            vehicles.filter(v => !v.inUse).forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = vehicle.plate;
                vehicleSelect.appendChild(option);
            });
        };

        // L√≥gica de Eventos
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                if (user.role === 'admin') {
                    renderScreen('admin');
                } else {
                    renderScreen('driver');
                }
            } else {
                showModal('Usu√°rio ou senha incorretos.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            renderScreen('login');
        });

        driverLogoutBtn.addEventListener('click', () => {
            currentUser = null;
            renderScreen('login');
        });

        // Eventos do Admin
        manageUsersBtn.addEventListener('click', () => renderScreen('manageUsers'));
        manageVehiclesBtn.addEventListener('click', () => renderScreen('manageVehicles'));
        viewTripsBtn.addEventListener('click', () => renderScreen('viewTrips'));
        viewReportBtn.addEventListener('click', () => renderScreen('viewReport'));
        backToAdminMenuBtn.addEventListener('click', () => renderScreen('admin'));

        document.getElementById('userForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newId = `user${Date.now()}`;
            users.push({ id: newId, username: e.target.userName.value, password: e.target.userPassword.value, role: 'driver' });
            saveData();
            renderUserTable();
            e.target.reset();
        });

        const deleteUser = (userId) => {
            users = users.filter(u => u.id !== userId);
            saveData();
            renderUserTable();
        };

        document.getElementById('vehicleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newId = `vehicle${Date.now()}`;
            vehicles.push({ id: newId, plate: e.target.vehiclePlate.value.toUpperCase(), inUse: false });
            saveData();
            renderVehicleTable();
            e.target.reset();
        });

        const deleteVehicle = (vehicleId) => {
            vehicles = vehicles.filter(v => v.id !== vehicleId);
            saveData();
            renderVehicleTable();
        };

        filterTripInput.addEventListener('input', (e) => renderTripStatus(e.target.value));

        generatePdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const driverId = reportDriverSelect.value;
            const periodDays = parseInt(reportPeriodSelect.value);

            const now = new Date();
            const periodStart = new Date(now.setDate(now.getDate() - periodDays));

            const reportTrips = trips.filter(trip => {
                const isWithinPeriod = new Date(trip.endTime) > periodStart;
                const isCorrectDriver = !driverId || trip.driver === driverId;
                return isWithinPeriod && isCorrectDriver && trip.status === 'completed';
            });

            const data = reportTrips.map(trip => [
                new Date(trip.startTime).toLocaleDateString(),
                users.find(u => u.id === trip.driver)?.username,
                vehicles.find(v => v.id === trip.vehicle)?.plate,
                trip.destination,
                trip.startKm,
                trip.endKm,
                trip.endKm - trip.startKm
            ]);

            doc.autoTable({
                head: [['Data', 'Motorista', 'Ve√≠culo', 'Destino', 'KM Inicial', 'KM Final', 'Total KM']],
                body: data,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [75, 85, 99] }
            });

            doc.text('Assinatura do Administrador: _________________________', 14, doc.autoTable.previous.finalY + 20);

            doc.save(`relatorio_${reportDriverSelect.options[reportDriverSelect.selectedIndex].text}_ultimos_${periodDays}_dias.pdf`);
        });

        downloadCsvBtn.addEventListener('click', () => {
            const completedTrips = trips.filter(t => t.status === 'completed');
            if (completedTrips.length === 0) {
                showModal('Nenhuma viagem encerrada para exportar.');
                return;
            }
            const headers = ['Motorista', 'Ve√≠culo', 'Destino', 'KM Inicial', 'KM Final', 'KM Percorrido', 'Data de In√≠cio', 'Data de Fim'];
            const data = completedTrips.map(trip => {
                const driverName = users.find(u => u.id === trip.driver)?.username;
                const vehiclePlate = vehicles.find(v => v.id === trip.vehicle)?.plate;
                return [
                    driverName,
                    vehiclePlate,
                    trip.destination,
                    trip.startKm,
                    trip.endKm,
                    trip.endKm - trip.startKm,
                    new Date(trip.startTime).toLocaleString(),
                    new Date(trip.endTime).toLocaleString()
                ];
            });

            const csvContent = [
                headers.join(','),
                ...data.map(row => row.map(value => `"${value}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'viagens_encerradas.csv';
            link.click();
        });

        // Eventos do Motorista
        tripForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const startKm = parseFloat(document.getElementById('startKm').value);
            const vehicleId = document.getElementById('vehicleSelect').value;
            const destination = document.getElementById('destination').value;
            const newTripId = `trip${Date.now()}`;
            
            const newTrip = {
                id: newTripId,
                driver: currentUser.id,
                vehicle: vehicleId,
                destination: destination,
                startKm: startKm,
                endKm: null,
                startTime: new Date(),
                endTime: null,
                status: 'in-transit'
            };
            trips.push(newTrip);
            currentTrip = newTrip;

            const vehicleInUse = vehicles.find(v => v.id === vehicleId);
            if (vehicleInUse) {
                vehicleInUse.inUse = true;
            }

            saveData();
            updateDriverTripUI();
            showModal('Viagem iniciada com sucesso!');
        });

        endTripBtn.addEventListener('click', () => {
            const endKm = parseFloat(document.getElementById('startKm').value);
            if (endKm < currentTrip.startKm) {
                showModal('A quilometragem final n√£o pode ser menor que a inicial.');
                return;
            }
            const tripIndex = trips.findIndex(t => t.id === currentTrip.id);
            if (tripIndex !== -1) {
                trips[tripIndex].endKm = endKm;
                trips[tripIndex].endTime = new Date();
                trips[tripIndex].status = 'completed';
            }

            const vehicleInUse = vehicles.find(v => v.id === currentTrip.vehicle);
            if (vehicleInUse) {
                vehicleInUse.inUse = false;
            }
            
            saveData();
            updateDriverTripUI();
            renderMyTrips();
            showModal('Viagem encerrada com sucesso!');
        });

        // L√≥gica de Modo Claro/Escuro
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.querySelector('.sun-icon');
        const moonIcon = document.querySelector('.moon-icon');

        const isDarkMode = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
            show(moonIcon);
            hide(sunIcon);
        } else {
            document.documentElement.classList.remove('dark');
            show(sunIcon);
            hide(moonIcon);
        }

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            if (isDark) {
                localStorage.setItem('theme', 'dark');
                show(moonIcon);
                hide(sunIcon);
            } else {
                localStorage.setItem('theme', 'light');
                show(sunIcon);
                hide(moonIcon);
            }
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderScreen('login');
        });

    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    // üîë Configure aqui a URL e a Anon Key do seu projeto
    const SUPABASE_URL = "https://selxmiekvyiqqgfcvhzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlbHhtaWVrdnlpcXFnZmN2aHp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MzExNzAsImV4cCI6MjA3MzMwNzE3MH0.WPJ0fltKZBz6epGsAiKq_4M3ptELw0Em8caV-2n84wc";
    
    export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

</body>


</html>
